# 农业政策智能解读平台——系统设计文档

## 1. 概述

本系统是一个“一键生成政策图文解读”的演示平台，面向农业政策场景。用户可以上传或选择多种格式的政策文件（PDF / Word / HTML / Web 网页 URL），系统通过统一的检索与大模型解读管线，自动生成政策的结构化要点与可视化解读界面。

系统主要能力：

- **多格式政策源解析**：支持 PDF、常见 Office 文档以及网页 URL，统一转换为 PDF 后进入检索管线。
- **视觉增强检索（Visual RAG）**：对政策 PDF 进行文本与视觉双模态检索，覆盖扫描件、表格截图等场景。
- **结构化多维度问答**：围绕“申报主体、资金用途、补贴标准、申报门槛、合规要求、时间节点、流程与材料”等 7 个维度进行结构化抽取，并生成一句话总结及 AI 行动建议。
- **异步任务编排**：前端创建解读任务，后端以异步 Job 的形式执行解析与问答，前端轮询任务状态并展示结果。


## 2. 整体架构

系统采用前后端分离架构：

- **前端**：基于 React + Vite 的单页应用（`policy_frontend_react`）。
  - 负责文件上传、URL 输入、模型参数配置、任务发起与结果展示。
  - 通过 `src/api.js` 调用后端 REST API。
- **后端 API**：基于 FastAPI 的服务（`policy_api_fastapi.py`）。
  - 提供健康检查、政策文件扫描/上传、解读任务创建与查询等接口。
  - 在内存中维护 Job 状态，并使用 `BackgroundTasks` 异步执行实际计算。
- **检索与解读管线**：`retrieval_pipe.py` + `visual_rag.py` + `utils.PDFConverter`。
  - 负责统一将多格式输入转换为 PDF。
  - 使用 Visual RAG 引擎对 PDF 进行索引与问答。
  - 对 7 个政策问题逐一调用 Visual RAG，并在后端增加“summary 一句话结论”和“actions AI 行动建议”两个衍生问题。
- **数据与文件存储**：
  - 源政策文件与转换后的 PDF 存放在 `./policy_data` 目录下：
    - `policy_data/docs`：用于 Visual RAG 的 PDF 文件。
    - `policy_data/uploads`：前端上传文件的默认存放目录。
  - 解读输出及中间日志存放在 `./policy_outputs` 与 `policy_data/retrieval` 中（由 Visual RAG 管线负责）。

整体调用链路如下：

1. 前端上传文件或选择已有文件 / 输入 URL。
2. 前端调用 `POST /api/policy/jobs` 创建解读任务。
3. 后端校验配置，创建 `job_id`，异步执行 `_run_job`：
   - 构建 `PolicyRetrievalPipeline`；
   - 统一将输入转换为 PDF 并写入 `policy_data/docs`；
   - 构建 `VisualRAGPipeline` 并逐问题调用；
   - 补充 summary 与 actions 字段；
   - 将结果写入内存中的 `JOBS[job_id]["result"]`。
4. 前端以 `GET /api/policy/jobs/{job_id}` 轮询任务状态并展示结果。


## 3. 后端设计

### 3.1 FastAPI 应用

后端入口文件为 `policy_api_fastapi.py`：

- 设置 `HF_ENDPOINT` 镜像环境变量，加速 Hugging Face 相关依赖。
- 使用 `load_dotenv()` 从 `.env` 读取模型相关 API Key。
- 定义 FastAPI 应用 `app = FastAPI(title="Policy Reader API", version="0.1.0")`。
- 配置 CORS，允许来自 `localhost:5173`（Vite 开发）及 `localhost:3000` 的前端调用。

#### 3.1.1 文件扫描与上传

- `ALLOWED_EXTENSIONS`：统一管理允许的政策文件扩展名（`.pdf`, `.doc`, `.docx`, `.odt`, `.rtf`, `.html`, `.htm`, `.xhtml`）。
- `scan_policy_files(data_dir: str)`：
  - 遍历 `./policy_data` 目录，收集所有允许扩展名的文件相对路径。
  - 用于 `GET /api/policy/files` 接口。
- `save_uploaded_files(uploaded_files, base_dir="./policy_data/uploads")`：
  - 校验上传文件类型是否在 `ALLOWED_EXTENSIONS` 中。
  - 将文件落盘到 `policy_data/uploads`，返回相对路径列表。

#### 3.1.2 作业配置与模型选择

- `JobConfig`（Pydantic 模型）：
  - `llm_model`：`"doubao" | "gpt4" | "qwen"`。
  - `vision_retriever`：`"colpali" | "colqwen" | "nemo"`。
  - `top_k`：检索返回的上下文条数。
  - `force_reindex`：是否强制重建索引。
  - `qa_prompt`：统一问答提示词。
  - `doubao_api_key` / `openai_api_key` / `qwen_server_url` / `qwen_model_name`：可由请求显式传入，也可以回落到环境变量。

- `CreateJobRequest`：接收前端传入的 `inputs`（文件路径或 URL 列表）与 `config`（`JobConfig`）。

- `_build_pipeline(cfg: JobConfig) -> PolicyRetrievalPipeline`：
  - 基于配置组装 `PolicyRetrievalPipeline`。
  - 将可用的 API Key 打包为 `api_keys` 字典传入。

#### 3.1.3 Job 管理与异步执行

- 内存态 Job 存储：`JOBS: Dict[str, Dict[str, Any]]`，以 `job_id` 为 key。
- `_run_job(job_id, inputs, cfg)`：
  - 标记 Job 状态为 `running`，清空上一次结果。
  - 在 `asyncio.to_thread` 中执行 `_work()` 以避免阻塞事件循环。
  - `_work()` 流程：
    1. 构建 `PolicyRetrievalPipeline`；
    2. `pipeline.add_inputs(inputs)` 统一转换为 PDF，并注册到 `self._pdf_entries`；
    3. `pipeline._ensure_visdom()` 初始化 Visual RAG 引擎；
    4. 遍历 `POLICY_QUESTIONS`，逐问题调用 `pipeline._visdom.answer_question(question)`；
    5. 将每个问题的 `question/answer/analysis` 写入 `partial` 字典，并持续更新 `JOBS[job_id]["result"]`；
    6. 构造基于 7 个维度答案的一句话总结 Prompt，调用 `generate_text_only` 得到 `summary` 字段；
    7. 再次构造 AI 行动建议 Prompt，调用 `generate_text_only` 得到 `actions` 字段；
    8. 将最终 `partial` 复制回 `JOBS[job_id]["result"]`。
  - 异步函数 `_run_job` 捕获异常并更新 Job 状态为 `failed`，记录错误信息。

#### 3.1.4 外部可见 API

详见《接口说明书》，主要包括：

- `GET /api/health`：健康检查。
- `GET /api/policy/files`：扫描并返回可用政策文件列表。
- `POST /api/policy/upload`：接收上传文件并保存到 `policy_data/uploads`。
- `POST /api/policy/jobs`：创建政策解读任务。
- `GET /api/policy/jobs/{job_id}`：查询任务状态与结果。


## 4. 检索与解读管线设计

### 4.1 PolicyRetrievalPipeline（retrieval_pipe.py）

`PolicyRetrievalPipeline` 负责将多格式输入统一转换为 PDF，并配置 Visual RAG 引擎完成检索与问答。

关键要点：

- 初始化参数：
  - `data_dir` / `output_dir`：数据与输出根目录，默认 `./policy_data`、`./policy_outputs`。
  - `llm_model` / `vision_retriever` / `top_k` / `force_reindex` / `qa_prompt` 等，与 `JobConfig` 一致。
  - `api_keys`：封装各类模型所需的 Key。
  - `qwen_server_url` / `qwen_model_name`：Qwen-VL vLLM 服务参数。
- 内部维护：
  - `self.docs_dir = os.path.join(data_dir, "docs")` 用于放置 PDF 文档；
  - `self.converter = PDFConverter()` 负责 Word/HTML/URL -> PDF 转换；
  - `_pdf_entries`：记录相对 `data_dir` 的 PDF 列表，如 `"docs/file.pdf"`；
  - `_config`：向 `VisualRAGPipeline` 传入的统一配置字典。

#### 4.1.1 文档准备：统一转 PDF

- `add_inputs(inputs: List[str]) -> List[str]`：
  - 若输入为本地路径：
    - 根据扩展名判断是 Word / HTML / PDF。
    - Word/HTML：调用 `PDFConverter.convert(item, pdf_abs)` 转为 PDF。
    - PDF：若不在 `docs` 目录下，则复制到 `docs`。
  - 若输入为 URL：
    - 通过 `_slugify(url)` 生成可用文件名；
    - 调用 `PDFConverter.url_to_pdf(url, pdf_abs)` 将网页渲染为 PDF。
  - 所有生成的 PDF 均追加到 `_pdf_entries`，并返回绝对路径列表。

- `_ensure_visdom()`：
  - 确认 `_pdf_entries` 非空，将其写入 `_config["pdf_files"]`；
  - 基于 `_config` 初始化 `VisualRAGPipeline`，保存在 `self._visdom`。

#### 4.1.2 检索问答

- `retrieve_policy_info(inputs)`：
  - 高层封装函数，用于一次性完成 `add_inputs` 和问答。
  - 遍历 `POLICY_QUESTIONS`，对每个问题调用 `self._visdom.answer_question` 获取 `answer` 与 `analysis`。

### 4.2 VisualRAGPipeline 与 VisualRAGEngine（visual_rag.py）

`visual_rag.py` 中的 `VisualRAGPipeline` 是对底层 `VisualRAGEngine` 的包装。

- 构造函数中：
  - 初始化 `data_dir`、`output_dir`、`llm_model`、`vision_retriever`、`top_k` 等参数；
  - 创建检索与输出目录；
  - 初始化 LLM 客户端：
    - `doubao`：通过 `OpenAI` 兼容客户端调用 Doubao API；
    - `gpt4`：通过 `OpenAI` 官方 Python SDK；
    - `qwen`：通过外部 vLLM HTTP 服务（OpenAI 接口兼容）。
  - 初始化 `VisualRAGEngine`，实际负责：
    - 文档解析与切块；
    - 文本/图像向量化与索引；
    - `answer_question` 与 `generate_text_only` 等接口。


## 5. 前端设计

前端代码位于 `policy_frontend_react` 目录：

- 构建工具：Vite
- 框架：React 18
- 主要文件：
  - `src/App.jsx`：单页应用入口，包含页面布局与状态管理。
  - `src/api.js`：封装调用后端 API 的函数。
  - `src/components/Card.jsx`：通用卡片组件。
  - `src/styles.css`：页面样式。

### 5.1 前端主要功能模块

1. **工具栏与文件/URL 输入**：
   - “上传政策文件”按钮：打开设置弹窗，支持：
     - 从后端扫描到的 `policy_data` 中选择现有文件；
     - 上传新文件（保存到 `policy_data/uploads`）；
     - 输入多个政策网页 URL。
   - “提取政策信息”按钮：触发 `onExtract()`，调用 `createJob` 接口创建解读任务。

2. **解读任务状态轮询**：
   - 使用 React `useEffect` 监听 `jobId` 变化，定时调用 `getJob(jobId)`。
   - 根据返回的 `status` 更新页面状态（queued / running / succeeded / failed）。

3. **可视化解读界面**：
   - 【政策要点总览】：一句话结论 + 要点列表 + 基础信息（来源、发布时间、截止时间、任务状态）。
   - 【支持内容与申报规则】：
     - 三列展示：支持对象、不适用/负面清单、扶持方式与资金规则；
     - 底部左右两列：核心申报条件（标签形式）与折叠的申报材料清单。
   - 【影响解读与行动建议】：
     - 左侧：政策影响（示意条形图 + 关键时间窗口 + 影响要点）；
     - 右侧：AI 行动建议。
   - 右侧侧边栏：数字人播报（占位）、解读目录、关联政策列表。

4. **Markdown 渲染**：
   - 使用 `react-markdown` + `remark-gfm` 将答案中的列表/强调等 Markdown 语法以富文本方式展示。


## 6. 数据与状态管理

### 6.1 后端 Job 状态

后端使用内存字典 `JOBS` 管理任务：

```python
JOBS[job_id] = {
    "status": "queued" | "running" | "succeeded" | "failed",
    "error": Optional[str],
    "result": Optional[Dict[str, Dict[str, str]]],
    "inputs": List[str],
}
```

在 `_run_job` 执行过程中，多次更新 `result` 字段，以支持长任务时前端提前看到部分结果（前端当前实现主要在任务完成后一次性使用）。

### 6.2 前端状态

`App.jsx` 中维护的关键状态包括：

- 文件与输入：`files`, `selectedFiles`, `uploadedPaths`, `urls`, `inputs`。
- 任务状态：`jobId`, `jobStatus`, `result`, `busy`, `error`。
- 模型配置：`config`（与后端 `JobConfig` 一一对应）。
- UI 状态：`settingsOpen`（配置弹窗开关）。


## 7. 扩展与演进方向

- **持久化 Job 管理**：当前 Job 状态存储在内存中，适合 Demo 与单机部署；若要支持多实例或长期任务管理，可迁移到数据库或队列系统（如 Redis + Celery/RQ）。
- **更多政策维度**：在 `POLICY_QUESTIONS` 中扩展新的问题维度，如“政策背景”、“与既有政策关系”等，前端可相应新增卡片版块。
- **多模型路由与回退**：根据文件长度、复杂度动态选择模型（如优先使用本地/便宜模型，必要时回退到高性能模型）。
- **用户与权限体系**：在 API 层面增加用户认证与配额控制，对上传文件与调用次数进行管理。
- **日志与可观测性**：增加统一日志格式，对解析、检索和 LLM 调用过程的耗时与错误进行监控，方便运维和后续优化。


## 8. 部署建议

- **后端服务**：
  - 使用 Uvicorn/Gunicorn 运行 FastAPI 应用，例如 `uvicorn policy_api_fastapi:app --host 0.0.0.0 --port 8000`。
  - 通过环境变量 `.env` 配置所需模型 Key 与 Qwen-VL 服务地址。
- **前端应用**：
  - 在 `policy_frontend_react` 目录下使用 `npm install` / `pnpm install` 安装依赖；
  - 开发模式：`npm run dev`，默认端口 5173；
  - 生产模式：`npm run build` 后将 `dist` 目录部署到静态资源服务器（如 Nginx）。
- **模型与检索服务**：
  - 若使用 Qwen-VL vLLM，需额外部署兼容 OpenAI 接口的服务，并在配置中填写 `qwen_server_url` 与 `qwen_model_name`。


