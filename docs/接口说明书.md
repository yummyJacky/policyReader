# 农业政策智能解读平台——接口说明书

本文档描述当前 FastAPI 后端对外暴露的 HTTP 接口，包括请求方式、参数、返回结构以及典型调用示例。

基础信息：

- **服务名称**：Policy Reader API
- **基础 URL（示例开发环境）**：`http://localhost:8000`
- **统一前缀**：所有接口前均带有 `/api` 前缀

---

## 1. 健康检查接口

### 1.1 GET /api/health

- **功能描述**：
  - 检查后端服务是否正常运行。
- **请求方式**：GET
- **请求参数**：无
- **返回结果**：

```json
{
  "status": "ok"
}
```

- **错误码**：正常情况下无错误，若返回非 200 状态码则表示服务异常。

---

## 2. 政策文件扫描接口

### 2.1 GET /api/policy/files

- **功能描述**：
  - 扫描服务器本地 `./policy_data` 目录下的所有政策文件，返回相对路径列表。
  - 支持的扩展名由后端 `ALLOWED_EXTENSIONS` 控制，包含：`.pdf`, `.doc`, `.docx`, `.odt`, `.rtf`, `.html`, `.htm`, `.xhtml`。
- **请求方式**：GET
- **请求参数**：无

- **返回结果**：

```json
{
  "files": [
    "policy_data/docs/demo_policy.pdf",
    "policy_data/uploads/2023_xx_policy.docx"
  ]
}
```

- **错误码**：
  - `200 OK`：成功；若目录不存在则返回空列表。

---

## 3. 政策文件上传接口

### 3.1 POST /api/policy/upload

- **功能描述**：
  - 接收用户上传的政策文件，将其保存到 `./policy_data/uploads` 目录，返回保存后的相对路径列表。
- **请求方式**：POST
- **请求体类型**：`multipart/form-data`
- **请求参数**：

  - `files`：必填，多文件字段，每个元素为一个待上传文件。

- **返回结果**：

```json
{
  "saved_paths": [
    "policy_data/uploads/政策示例1.pdf",
    "policy_data/uploads/政策示例2.docx"
  ]
}
```

- **错误码**：
  - `200 OK`：上传成功。
  - `400 Bad Request`：文件扩展名不在允许列表中，`detail` 字段会包含类似 `"不支持的文件类型: .txt"` 的提示。

- **示例（curl）**：

```bash
curl -X POST "http://localhost:8000/api/policy/upload" \
  -F "files=@/path/to/policy1.pdf" \
  -F "files=@/path/to/policy2.docx"
```

---

## 4. 政策解读任务接口

### 4.1 POST /api/policy/jobs

- **功能描述**：
  - 创建一个新的政策解读任务。后端会在后台异步执行检索与大模型调用，前端通过 `job_id` 轮询任务状态。
- **请求方式**：POST
- **请求体类型**：`application/json`

- **请求体结构**：

```json
{
  "inputs": ["policy_data/uploads/某政策文件.pdf", "https://www.moa.gov.cn/xx/xx"],
  "config": {
    "llm_model": "doubao",
    "vision_retriever": "colpali",
    "top_k": 5,
    "force_reindex": false,
    "qa_prompt": "请基于给定政策文本，客观提取和归纳关键信息。请务必用中文回答问题。",
    "doubao_api_key": "可选，若为空则尝试从环境变量 ARK_API_KEY 读取",
    "openai_api_key": "可选，若为空则尝试从 OPENAI_API_KEY 读取",
    "qwen_server_url": "可选，若为空则尝试从 QWEN_VL_SERVER_URL 读取",
    "qwen_model_name": "可选，若为空则尝试从 QWEN_VL_MODEL_NAME 读取"
  }
}
```

- **字段说明**：

  - `inputs`：
    - 类型：`string[]`
    - 说明：待解读的政策源列表，可以是：
      - 服务端可访问的本地文件相对路径（通常来自 `/api/policy/files` 或 `/api/policy/upload` 返回值）；
      - 以 `http://` 或 `https://` 开头的网页 URL。
    - 约束：不能为空，否则会返回 400 错误。

  - `config`：
    - 类型：对象，详见 `JobConfig` 模型。

    - `llm_model`：
      - 可选值：`"doubao"`, `"gpt4"`, `"qwen"`；
      - 默认：`"doubao"`。
      - 若选择 `doubao`，必须提供 `doubao_api_key` 或设置环境变量 `ARK_API_KEY`。
      - 若选择 `gpt4`，必须提供 `openai_api_key` 或设置环境变量 `OPENAI_API_KEY`。
      - 若选择 `qwen`，必须提供 `qwen_server_url` 或设置环境变量 `QWEN_VL_SERVER_URL`。

    - `vision_retriever`：
      - 可选值：`"colpali"`, `"colqwen"`, `"nemo"`；
      - 默认：`"colpali"`。

    - `top_k`：
      - 类型：整数，范围 `[1, 10]`；
      - 说明：每个问题在检索阶段返回的候选片段数量。

    - `force_reindex`：
      - 类型：布尔；
      - 说明：是否强制重建检索索引，适用于调试或文档内容有明显变更的场景。

    - `qa_prompt`：
      - 类型：字符串；
      - 说明：统一的问答 Prompt，将在 VisualRAG 内部作为问题回答时的系统提示语。

    - `doubao_api_key` / `openai_api_key` / `qwen_server_url` / `qwen_model_name`：
      - 类型：字符串或 `null`；
      - 若请求体中为 `null`，后端会尝试从对应环境变量中读取默认值。

- **成功返回结果**（响应模型：`JobStatusResponse`）：

```json
{
  "job_id": "c0f18f7b9f8640b6ad1c4a9f9ed5c123",
  "status": "queued",
  "error": null,
  "result": null
}
```

- **错误码**：

  - `400 Bad Request`：
    - `"inputs 不能为空"`：`inputs` 为空数组。
    - `"已选择 doubao 模型，但 doubao_api_key / ARK_API_KEY 为空"`。
    - `"已选择 gpt4 模型，但 openai_api_key / OPENAI_API_KEY 为空"`。
    - `"已选择 qwen 模型，但 qwen_server_url / QWEN_VL_SERVER_URL 为空"`。

- **示例（curl）**：

```bash
curl -X POST "http://localhost:8000/api/policy/jobs" \
  -H "Content-Type: application/json" \
  -d '{
    "inputs": ["policy_data/uploads/demo_policy.pdf"],
    "config": {
      "llm_model": "doubao",
      "vision_retriever": "colpali",
      "top_k": 5,
      "force_reindex": false,
      "qa_prompt": "请基于给定政策文本，客观提取和归纳关键信息。请务必用中文回答问题。"
    }
  }'
```

---

### 4.2 GET /api/policy/jobs/{job_id}

- **功能描述**：
  - 根据 `job_id` 查询指定政策解读任务的执行状态与结果。
- **请求方式**：GET
- **路径参数**：

  - `job_id`：在 `POST /api/policy/jobs` 响应中返回的任务 ID。

- **返回结果**（响应模型：`JobStatusResponse`）：

```json
{
  "job_id": "c0f18f7b9f8640b6ad1c4a9f9ed5c123",
  "status": "succeeded",
  "error": null,
  "result": {
    "who": {
      "question": "根据政策文件，申报主体是谁？谁可以申报？请概括主体类型和适用范围。",
      "answer": "……",
      "analysis": "……"
    },
    "what": {
      "question": "根据政策文件，资金主要用于哪些具体方向或环节？",
      "answer": "……",
      "analysis": "……"
    },
    "how_much": { "question": "…", "answer": "…", "analysis": "…" },
    "threshold": { "question": "…", "answer": "…", "analysis": "…" },
    "compliance": { "question": "…", "answer": "…", "analysis": "…" },
    "when": { "question": "…", "answer": "…", "analysis": "…" },
    "how": { "question": "…", "answer": "…", "analysis": "…" },
    "summary": { "question": "…", "answer": "一句话总结……", "analysis": "" },
    "actions": { "question": "…", "answer": "- 建议1\n- 建议2\n…", "analysis": "" }
  }
}
```

- **字段说明**：

  - `status`：任务状态。
    - `"queued"`：已创建等待执行；
    - `"running"`：正在执行检索与模型调用；
    - `"succeeded"`：任务完成且`result`包含完整结果；
    - `"failed"`：任务失败，可查看 `error` 字段了解原因。

  - `result`：
    - 字典结构，以问题 key（`who`、`what`、`how_much` 等）为键；
    - 每个键对应一个对象：`{"question", "answer", "analysis"}`；
    - `summary`：后端基于七个维度答案整理的一句话结论；
    - `actions`：面向申报主体的 3–6 条行动建议，通常为 Markdown 列表格式。

- **错误码**：

  - `404 Not Found`：`job_id` 不存在，返回：

```json
{
  "detail": "job 不存在"
}
```


