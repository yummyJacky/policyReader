# 农业政策智能解读平台——用户使用手册

本手册面向该 Demo 系统的最终使用者和运维人员，介绍如何启动系统、上传政策文件并生成政策图文解读。

---

## 1. 系统功能概览

本系统提供以下核心功能：

- **多格式政策文件接入**：支持 PDF、Word（doc/docx）、RTF、HTML 以及网页 URL。
- **一键生成解读**：用户选择/上传政策后，点击“提取政策信息”，系统自动完成检索与大模型解读。
- **多维度结构化结果**：从申报主体、资金用途、补贴标准、申报门槛、合规要求、时间节点、流程与材料等 7 个维度展示结果，并生成一句话总结和 AI 行动建议。
- **图文可视化界面**：通过多个卡片模块，以图表、进度条、标签等形式呈现政策要点。

---

## 2. 环境准备与启动

### 2.1 必要依赖

- 操作系统：Linux 或其他支持 Python / Node 环境的系统
- Python：3.9+（建议使用虚拟环境）
- Node.js：推荐 18+（用于前端构建）

### 2.2 后端启动

1. 进入项目根目录 `policyReader`。
2. 安装 Python 依赖（如项目提供 `requirements.txt`，可使用）：

```bash
pip install -r requirements.txt
```

3. 配置模型相关环境变量（可写入 `.env` 文件）：

```env
ARK_API_KEY=你的_doubao_key
OPENAI_API_KEY=你的_openai_key   # 若使用 GPT-4
QWEN_VL_SERVER_URL=http://localhost:8001  # 若使用 Qwen-VL vLLM
QWEN_VL_MODEL_NAME=Qwen/Qwen2.5-VL-7B-Instruct
```

4. 启动 FastAPI 服务（示例）：

```bash
uvicorn policy_api_fastapi:app --host 0.0.0.0 --port 8000
```

5. 浏览器访问 `http://localhost:8000/api/health`，若返回 `{ "status": "ok" }` 说明后端工作正常。

### 2.3 前端启动

1. 进入前端目录：

```bash
cd policy_frontend_react
```

2. 安装依赖：

```bash
npm install
# 或者 pnpm install / yarn
```

3. 开发模式启动：

```bash
npm run dev
```

默认会在 `http://localhost:5173` 启动前端页面，确保浏览器访问时后端 `http://localhost:8000` 已经启动。

> 注意：若后端端口或域名有变化，需要在部署时通过反向代理或调整前端请求路径来适配。

---

## 3. 页面操作指南

### 3.1 首页结构

打开前端页面后，可以看到一个类似“政策解读仪表盘”的界面，主要分为：

- 顶部：系统标题、搜索框（展示用）、用户与通知图标。
- 中间左侧：三张主要卡片——
  - 【政策要点总览】
  - 【支持内容与申报规则】
  - 【影响解读与行动建议】
- 中间右侧：
  - “数字人播报”（占位）
  - “解读目录”
  - “关联政策”列表
- 顶部工具栏：
  - “上传政策文件”按钮
  - “提取政策信息”按钮
  - 当前解读的政策标题

### 3.2 上传或选择政策文件

1. 点击 **“上传政策文件”** 按钮，弹出配置弹窗。

2. 在 **“政策来源”** 面板中，你可以：

   - **选择已有政策文件**：
     - 下拉框中会列出服务器 `./policy_data` 目录中已存在的政策文件路径；
     - 支持多选，可一次性选择多份政策进行联合解读（将被视为同一批次）。

   - **上传新政策文件**：
     - 通过“上传政策文件（保存到 policy_data/uploads）”文件选择框，从本地选择一个或多个文件；
     - 支持的格式包括：PDF、Word（doc/docx）、RTF、HTML 等；
     - 上传成功后，弹窗内会显示“已上传：xxx.pdf, yyy.docx”等提示。

   - **输入政策网页 URL**：
     - 在“政策网页 URL（每行一个，可选）”文本框中，粘贴一个或多个政策网页链接（例如农业农村部官网政策页面）；
     - 每行一个 URL，系统会自动将其渲染为 PDF 后进入后续检索流程。

3. 弹窗底部的“本次输入：X 条”会实时显示当前将要参与解读的文件/URL 数量。

4. 设置完毕后，点击右上角“关闭”按钮返回主界面；所选输入会保留在内存中，无需重复选择。

### 3.3 配置模型与参数

在同一个弹窗右侧的 **“模型与参数”** 面板中，可以配置：

- **视觉 LLM 模型**：`doubao / gpt4 / qwen`；
- **视觉检索模型**：`colpali / colqwen / nemo`；
- **Top-K**：每个问题检索到的候选上下文条数（1–10）；
- **force_reindex**：勾选后会强制重建索引，适用于调试或文档变更场景；
- **Prompt**：统一的问答提示词，可根据业务需要进行自定义；
- **Doubao ARK_API_KEY / OpenAI API Key / Qwen-VL 服务地址和模型名称**：
  - 可直接在页面中输入；
  - 若留空，则后端会尝试从环境变量中读取。

> 对于普通使用者，通常只需选择好模型类型，其余可保持默认。

### 3.4 一键生成政策解读

1. 确保已经通过弹窗选择或上传了至少一个政策源（文件或 URL）。
2. 点击顶部工具栏中的 **“提取政策信息”** 按钮：
   - 若尚未选择任何输入，系统会提示“请先上传/选择政策文件或输入 URL”，并自动打开弹窗。
   - 若输入与配置有效，前端会调用 `/api/policy/jobs` 创建解读任务，并在页面上显示“处理中…”状态。
3. 等待数秒至数十秒（取决于文档大小和模型速度），系统会自动轮询任务状态：
   - 任务成功后，对应卡片会展示解读结果；
   - 若任务失败，会在页面上方显示错误提示信息。

---

## 4. 解读结果说明

生成完成后，页面三张主卡片会展示以下信息：

### 4.1 【政策要点总览】

- **一句话结论**：
  - 基于 7 个维度答案自动生成，概括政策的核心目标与支持方向。
- **要点列表**：
  - 根据“申报门槛（threshold）”和“合规要求（compliance）”两部分内容提炼出的若干关键提醒，帮助读者快速把握硬条件与红线。
- **基本信息条**：
  - 政策来源：当前正在解读的文件名；
  - 发布时间、截止时间：根据“when”维度解析出的日期（若未识别则为 `-`）；
  - 任务状态：展示当前解读任务的状态（queued / running / succeeded / failed）。

### 4.2 【支持内容与申报规则】

主要分为两大区域：

1. **三列信息面板**：
   - 支持对象：对应 `who` 维度的提炼结果。
   - 不适用 / 负面清单：对应 `compliance` 维度。
   - 扶持方式与资金规则：综合 `how_much` 与 `what` 维度的信息。

2. **底部左右两列**：
   - 左侧“核心申报条件”：以标签形式展示 `threshold` 维度中提取的关键门槛。
   - 右侧“申报材料清单”：折叠面板形式展示 `how` 维度中和材料与流程相关的内容，点击标题可展开/收起。

### 4.3 【影响解读与行动建议】

- 左侧“政策影响”：
  - 示意性的条形图展示政策对财政支出和产业链的影响强度（主要为 UI 占位，实际解读信息来自文本）；
  - “申报窗口 / 截止”基于 `when` 维度日期解析；
  - 下方列表展示 `what` 维度中提炼的影响要点。

- 右侧“AI 行动建议”：
  - 对应后端生成的 `actions` 字段；
  - 以列表形式展示 3–6 条面向申报主体的操作建议与风险提示。

### 4.4 右侧侧边栏

- “数字人播报”：当前为占位按钮，可用于未来集成语音播报或视频数字人播放。
- “解读目录”：列出三大卡片模块，方便用户快速理解页面结构。
- “关联政策”：
  - 若本次解读选择了多个输入文件/URL，会在此展示其路径，方便用户了解同批次处理的其他政策。

---

## 5. 常见问题（FAQ）

### 5.1 上传文件后没有出现在下拉列表中？

- 检查后端日志中是否有“不支持的文件类型”等错误提示；
- 确认文件扩展名属于允许列表（`.pdf`, `.doc`, `.docx`, `.odt`, `.rtf`, `.html`, `.htm`, `.xhtml`）。

### 5.2 创建任务时报模型 Key 相关错误？

- 提示类似“已选择 doubao 模型，但 doubao_api_key / ARK_API_KEY 为空”：
  - 说明当前选择的模型没有配置对应的 API Key；
  - 可在前端弹窗中输入 Key，或者在后端 `.env` 文件中设置环境变量后重启服务。

### 5.3 任务长时间处于 queued 或 running 状态？

- 检查后端是否正在下载或加载模型（首次运行可能耗时较长）；
- 检查服务器资源（GPU/CPU/内存）是否充足；
- 查看后端终端输出的报错信息，必要时重启服务并缩小输入文档规模进行测试。

### 5.4 解读内容与原文不完全一致？

- 当前系统为基于 RAG + LLM 的智能解读 Demo，答案可能存在一定主观性；
- 建议：
  - 将关键内容与原文核对；
  - 调整 `qa_prompt` 的描述，更强调“客观引用原文内容”；
  - 如有需要，可在页面上增加“原文定位”功能（后续可扩展）。

---

## 6. 运维与扩展

- **日志查看**：
  - 解读管线会在 `policy_data/retrieval` 与 `policy_outputs` 中记录部分日志文件，可用来排查问题与分析性能。
- **数据清理**：
  - 对于不再需要的上传文件和输出结果，可定期清理 `policy_data/uploads` 与 `policy_outputs` 目录，避免磁盘占用过大。
- **自定义问答维度**：
  - 开发人员可在 `retrieval_pipe.POLICY_QUESTIONS` 中新增问题维度，并在前端新增对应展示模块。
- **模型切换与升级**：
  - 可通过环境变量或前端配置快速切换不同 LLM 与视觉检索模型，以对比解读效果。


